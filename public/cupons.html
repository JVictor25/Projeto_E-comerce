<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cupons - E-Commerce</title>
  <link rel="stylesheet" href="/css/cupons.css">
  <link rel="stylesheet" href="/css/header-footer.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="header"></div>
  <main class="cupons-container">
    <h1>Cupons</h1>
    <div class="cupons-list" id="cupons-list">
      <p>Carregando cupons...</p>
    </div>
  </main>
  <div id="footer"></div>
  <script src="/js/auth-manager.js"></script>
  <script src="/components/js/components.js"></script>
  <script>
    includeComponent('#header', '/components/header.html');
    includeComponent('#footer', '/components/footer.html');

    // Carregar produtos e cupons do backend
    let produtos = [];
    let cupons = [];

    async function loadData() {
      try {
        // Carregar produtos
        const produtosResponse = await fetch('/api/produtos');
        if (produtosResponse.ok) {
          produtos = await produtosResponse.json();
        }

        // Carregar cupons
        const cuponsResponse = await fetch('/api/cupons');
        if (cuponsResponse.ok) {
          cupons = await cuponsResponse.json();
        }

        renderCupons();
        
        // Salvar dados no localStorage para uso na página de detalhes
        localStorage.setItem('cupons', JSON.stringify(cupons));
        localStorage.setItem('produtos', JSON.stringify(produtos));
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        document.getElementById('cupons-list').innerHTML = 
          '<p>Erro ao carregar cupons. Tente novamente.</p>';
      }
    }

    // Renderizar cupons
    function renderCupons() {
      const list = document.getElementById('cupons-list');
      list.innerHTML = '';
      
      if (!cupons.length) {
        list.innerHTML = '<p>Nenhum cupom disponível no momento.</p>';
        return;
      }
      
      cupons.forEach(cupom => {
        console.log('DEBUG CUPOM:', cupom);
        const card = document.createElement('div');
        card.className = 'cupom-card';
        
        // Formatar limite (apenas para cupons de porcentagem)
        const limiteText = cupom.tipo === 'porcentagem' && cupom.limite 
          ? `R$ ${parseFloat(cupom.limite).toFixed(2)}` 
          : null;
        
        // Formatar condição
        const condicaoText = cupom.aplicavel_a === 'selecionados' 
          ? 'Em produtos selecionados' 
          : 'Em todos os produtos';
        
        card.innerHTML = `
          <div class="cupom-info">
            <div class="cupom-nome">${cupom.titulo || cupom.codigo}</div>
            <div class="cupom-desconto">${cupom.tipo === 'porcentagem' ? cupom.valor + '% OFF' : 'R$ ' + parseFloat(cupom.valor).toFixed(2) + ' OFF'}</div>
            <div class="cupom-condicao">${condicaoText}. Compra mínima R$ ${(Number(cupom.compra_minima) || 0).toFixed(2)}</div>
            ${limiteText ? `<div class="cupom-limite">Limite de ${limiteText}</div>` : ''}
            <div class="cupom-validade">Válido até ${new Date(cupom.data_fim).toLocaleDateString('pt-BR')}</div>
          </div>
          <button class="cupom-detalhes-btn" data-id="${cupom.id}">Detalhes</button>
        `;
        
        card.querySelector('.cupom-detalhes-btn').onclick = function() {
          window.location.href = `detalhe-cupom.html?id=${cupom.id}`;
        };
        
        list.appendChild(card);
      });
    }

    // Carregar dados quando a página carregar
    loadData();
  </script>
</body>
</html> 