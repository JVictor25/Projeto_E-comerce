<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Preços - Admin</title>
    <link rel="stylesheet" href="/css/header-footer.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .admin-header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .admin-nav {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #5a6fd8;
        }

        .nav-btn.active {
            background: #4c63d2;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            color: #333;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .precos-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .precos-table th,
        .precos-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .precos-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .precos-table tr:hover {
            background: #f8f9fa;
        }

        .preco-value {
            font-weight: bold;
            color: #28a745;
        }

        .preco-old {
            text-decoration: line-through;
            color: #6c757d;
            font-size: 12px;
        }

        .preco-change {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .preco-increase {
            background: #d4edda;
            color: #155724;
        }

        .preco-decrease {
            background: #f8d7da;
            color: #721c24;
        }

        .preco-same {
            background: #e2e3e5;
            color: #383d41;
        }

        .produto-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .produto-nome {
            font-weight: bold;
            color: #333;
        }

        .produto-id {
            font-size: 12px;
            color: #666;
        }

        .date-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .date-value {
            color: #333;
        }

        .date-days {
            font-size: 12px;
            color: #666;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .view-btn {
            background: #17a2b8;
            color: white;
        }

        .view-btn:hover {
            background: #138496;
        }

        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            color: #666;
            font-style: italic;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }
        .preco-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 1.2rem 1.5rem;
            display: flex;
            flex-direction: column;
            font-size: 1rem;
        }
        .preco-card strong {
            color: #6d28d9;
        }
        .preco-card .linha {
            display: flex;
            gap: 2rem;
            margin-bottom: 0.3rem;
        }
        .preco-card .linha span {
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .precos-table {
                font-size: 12px;
            }

            .precos-table th,
            .precos-table td {
                padding: 8px 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Painel Administrativo</h1>
            <div class="admin-nav">
                <a href="dashboard.html" class="nav-btn">Dashboard</a>
                <a href="produtos.html" class="nav-btn">Produtos</a>
                <a href="cupons.html" class="nav-btn">Cupons</a>
                <a href="galpoes.html" class="nav-btn">Galpões</a>
                <a href="precos.html" class="nav-btn active">Histórico de Preços</a>
                <button onclick="logout()" class="nav-btn" style="background: #dc3545;">Sair</button>
            </div>
        </div>

        <div class="content-area">
            <div class="section-header">
                <h2>Histórico de Preços</h2>
            </div>

            <!-- Estatísticas -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalProdutos">-</div>
                    <div class="stat-label">Total de Produtos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPrecos">-</div>
                    <div class="stat-label">Total de Preços</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="mediaPreco">-</div>
                    <div class="stat-label">Preço Médio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="produtosComHistorico">-</div>
                    <div class="stat-label">Produtos com Histórico</div>
                </div>
            </div>

            <!-- Filtro de Produto -->
            <div class="form-row">
                <div class="form-group" style="display: flex; align-items: flex-end; gap: 1rem;">
                    <div>
                        <label for="filterProduto">Produto:</label>
                        <select id="filterProduto" class="form-control"></select>
                    </div>
                    <button id="btnMostrarHistorico" type="button" class="nav-btn" style="height: 38px;">Mostrar Histórico</button>
                </div>
            </div>

            <!-- Lista de cards de histórico de preços -->
            <div id="cardsHistoricoPrecos" class="cards-container"></div>

            <!-- Gráfico -->
            <div class="chart-container">
                <div class="chart-title">Evolução de Preços</div>
                <div class="chart-placeholder" id="chartPlaceholder">
                    Gráfico será exibido aqui quando houver dados suficientes
                </div>
            </div>
        </div>
    </div>

    <script>
        let allPrecos = [];
        let allProdutos = [];
        let filteredPrecos = [];

        // Verificar autenticação
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            loadData();

            // Adicione os event listeners aqui!
            document.getElementById('btnMostrarHistorico').addEventListener('click', renderHistorico);
            document.getElementById('filterProduto').addEventListener('change', applyFilters);
            document.getElementById('filterPeriodo').addEventListener('change', applyFilters);
            document.getElementById('filterOrdenacao').addEventListener('change', applyFilters);
        });

        // Carregar dados
        async function loadData() {
            await Promise.all([
                loadPrecos(),
                loadProdutos()
            ]);
            updateStats();
            applyFilters();
        }

        // Carregar histórico de preços
        async function loadPrecos() {
            const token = localStorage.getItem('adminToken');
            
            try {
                const response = await fetch('/admin/precos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    allPrecos = await response.json();
                    filteredPrecos = [...allPrecos];
                } else {
                    console.error('Erro ao carregar histórico de preços');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        // Carregar produtos
        async function loadProdutos() {
            const token = localStorage.getItem('adminToken');
            
            try {
                const response = await fetch('/admin/produtos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    allProdutos = await response.json();
                    const select = document.getElementById('filterProduto');
                    select.innerHTML = '<option value="">Selecione um produto</option>';
                    allProdutos.forEach(prod => {
                        const opt = document.createElement('option');
                        opt.value = prod.id;
                        opt.textContent = prod.nome;
                        select.appendChild(opt);
                    });
                } else {
                    console.error('Erro ao carregar produtos');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        // Popular filtro de produtos
        function populateProdutoFilter() {
            const select = document.getElementById('filterProduto');
            select.innerHTML = '<option value="">Todos os produtos</option>';
            
            allProdutos.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = `${produto.nome} (ID: ${produto.id})`;
                select.appendChild(option);
            });
        }

        // Atualizar estatísticas
        function updateStats() {
            const totalProdutos = allProdutos.length;
            const totalPrecos = allPrecos.length;
            const produtosComHistorico = new Set(allPrecos.map(p => p.produto_id)).size;
            
            // Calcular preço médio
            const precosAtuais = allProdutos.map(p => Number(p.preco) || 0).filter(p => p > 0);
            const mediaPreco = precosAtuais.length > 0 
                ? (precosAtuais.reduce((sum, p) => sum + p, 0) / precosAtuais.length).toFixed(2)
                : '0.00';

            document.getElementById('totalProdutos').textContent = totalProdutos;
            document.getElementById('totalPrecos').textContent = totalPrecos;
            document.getElementById('mediaPreco').textContent = `R$ ${mediaPreco}`;
            document.getElementById('produtosComHistorico').textContent = produtosComHistorico;
        }

        // Aplicar filtros
        function applyFilters() {
            const produtoFilter = document.getElementById('filterProduto').value;
            const periodoFilter = document.getElementById('filterPeriodo').value;
            const ordenacao = document.getElementById('filterOrdenacao').value;

            // Filtrar por produto
            let filtered = allPrecos;
            if (produtoFilter) {
                filtered = filtered.filter(p => p.produto_id == produtoFilter);
            }

            // Filtrar por período
            if (periodoFilter) {
                const dias = parseInt(periodoFilter);
                const dataLimite = new Date();
                dataLimite.setDate(dataLimite.getDate() - dias);
                
                filtered = filtered.filter(p => {
                    const dataInicio = new Date(p.data_inicio);
                    return dataInicio >= dataLimite;
                });
            }

            // Ordenar
            filtered.sort((a, b) => {
                switch (ordenacao) {
                    case 'data_desc':
                        return new Date(b.data_inicio) - new Date(a.data_inicio);
                    case 'data_asc':
                        return new Date(a.data_inicio) - new Date(b.data_inicio);
                    case 'preco_desc':
                        return Number(b.preco) - Number(a.preco);
                    case 'preco_asc':
                        return Number(a.preco) - Number(b.preco);
                    case 'produto':
                        const produtoA = allProdutos.find(p => p.id == a.produto_id)?.nome || '';
                        const produtoB = allProdutos.find(p => p.id == b.produto_id)?.nome || '';
                        return produtoA.localeCompare(produtoB);
                    default:
                        return 0;
                }
            });

            filteredPrecos = filtered;
            displayPrecos();
        }

        // Exibir preços
        function displayPrecos() {
            const tbody = document.getElementById('precosTableBody');
            
            if (!filteredPrecos.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">Nenhum histórico de preço encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = filteredPrecos.map(preco => {
                const produto = allProdutos.find(p => p.id == preco.produto_id);
                const precoAnterior = getPrecoAnterior(preco);
                const variacao = calcularVariacao(precoAnterior, preco.preco);
                
                return `
                    <tr>
                        <td>
                            <div class="produto-info">
                                <div class="produto-nome">${produto ? produto.nome : 'Produto não encontrado'}</div>
                                <div class="produto-id">ID: ${preco.produto_id}</div>
                            </div>
                        </td>
                        <td>
                            <div class="preco-value">R$ ${Number(preco.preco).toFixed(2)}</div>
                            ${precoAnterior ? `<div class="preco-old">R$ ${Number(precoAnterior).toFixed(2)}</div>` : ''}
                        </td>
                        <td>
                            ${variacao ? `
                                <span class="preco-change ${variacao.tipo}">
                                    ${variacao.tipo === 'increase' ? '+' : variacao.tipo === 'decrease' ? '-' : ''}${variacao.percentual}%
                                </span>
                            ` : '-'}
                        </td>
                        <td>
                            <div class="date-info">
                                <div class="date-value">${formatDate(preco.data_inicio)}</div>
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <div class="date-value">${preco.data_fim ? formatDate(preco.data_fim) : 'Atual'}</div>
                                ${preco.data_fim ? `<div class="date-days">${calcularDias(preco.data_inicio, preco.data_fim)} dias</div>` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <div class="date-value">${calcularDias(preco.data_inicio)} dias</div>
                                <div class="date-days">até hoje</div>
                            </div>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="action-btn view-btn" onclick="viewProdutoPrecos(${preco.produto_id})">Ver Produto</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Obter preço anterior
        function getPrecoAnterior(precoAtual) {
            const precosDoProduto = allPrecos
                .filter(p => p.produto_id == precoAtual.produto_id)
                .sort((a, b) => new Date(a.data_inicio) - new Date(b.data_inicio));
            
            const index = precosDoProduto.findIndex(p => p.id == precoAtual.id);
            return index > 0 ? precosDoProduto[index - 1].preco : null;
        }

        // Calcular variação
        function calcularVariacao(precoAnterior, precoAtual) {
            if (!precoAnterior) return null;
            
            const variacao = ((Number(precoAtual) - Number(precoAnterior)) / Number(precoAnterior)) * 100;
            
            if (Math.abs(variacao) < 0.01) {
                return { tipo: 'same', percentual: '0.00' };
            }
            
            return {
                tipo: variacao > 0 ? 'increase' : 'decrease',
                percentual: Math.abs(variacao).toFixed(2)
            };
        }

        // Formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Calcular dias entre datas
        function calcularDias(dataInicio, dataFim = new Date()) {
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            const diffTime = Math.abs(fim - inicio);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Ver preços de um produto específico
        function viewProdutoPrecos(produtoId) {
            // Filtrar para mostrar apenas o produto selecionado
            document.getElementById('filterProduto').value = produtoId;
            applyFilters();
            renderHistorico(); // Atualizar a lista de cards
        }

        // Logout
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        }

        // Adicionar função para buscar vendas por id_preco
        async function getVendasPorPreco(id_preco) {
            const token = localStorage.getItem('adminToken');
            try {
                const res = await fetch(`/admin/precos/${id_preco}/vendas`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    return data.quantidade || 0;
                }
            } catch {}
            return 0;
        }

        async function renderHistorico() {
            const produtoId = document.getElementById('filterProduto').value;
            const container = document.getElementById('cardsHistoricoPrecos');
            container.innerHTML = '';
            const precos = produtoId ? allPrecos.filter(p => p.produto_id == produtoId) : [];
            if (precos.length === 0) {
                container.innerHTML = '<div style="color:#888">Nenhum histórico de preço para este produto.</div>';
                return;
            }
            for (const p of precos) {
                const div = document.createElement('div');
                div.className = 'preco-card';
                div.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <div class="linha"><span><strong>Data Início:</strong></span> <span>${p.data_inicio_vigencia ? p.data_inicio_vigencia.slice(0,10) : '-'}</span></div>
                            <div class="linha"><span><strong>Data Fim:</strong></span> <span>${p.data_fim ? p.data_fim.slice(0,10) : '-'}</span></div>
                            <div class="linha"><span><strong>Preço Total:</strong></span> <span>R$ ${p.preco_total != null ? Number(p.preco_total).toFixed(2) : '-'}</span></div>
                            <div class="linha"><span><strong>Preço com Desconto:</strong></span> <span>R$ ${p.preco_com_desconto != null ? Number(p.preco_com_desconto).toFixed(2) : '-'}</span></div>
                            <div class="linha"><span><strong>Qtd. Desconto:</strong></span> <span>${p.quantidade_de_desconto != null ? p.quantidade_de_desconto : '-'}</span></div>
                            <div class="linha"><span><strong>Tipo de Desconto:</strong></span> <span>${p.tipo_de_desconto || '-'}</span></div>
                        </div>
                        <div class="vendas-info" style="min-width:120px;text-align:right;">
                            <span style="font-size:13px;color:#888;">Vendas com este preço:</span><br>
                            <span class="qtd-vendas" style="font-size:1.5em;font-weight:bold;">...</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
                // Buscar vendas e atualizar
                const qtd = await getVendasPorPreco(p.id);
                div.querySelector('.qtd-vendas').textContent = qtd;
            }
        }
    </script>
</body>
</html> 